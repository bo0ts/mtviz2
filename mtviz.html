<html>
  <head>
    <title>mtviz2</title>
    <script type="text/javascript" src="protovis-r3.2.js"></script>

    <script type="text/javascript" src="data.js"></script>
    <script type="text/javascript" src="utility.js"></script>
    <script type="text/javascript" src="parsers.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
    <body>
      <div id="head">
      <script type="text/javascript">
        function update(variable, value) {
        variable = value;
        vis.render();
        }
        
        var r = 300,
        barsize = 30,
        width = r*2,
        lines = 2,
        margin = 20,
        shift_in = barsize/2;



        var timeout    = 500;
        var closetimer = 0;
        var ddmenuitem = 0;
        
        function jsddm_open()
        {  jsddm_canceltimer();
        jsddm_close();
        ddmenuitem = $(this).find('ul').css('visibility', 'visible');}
        
        function jsddm_close()
        {  if(ddmenuitem) ddmenuitem.css('visibility', 'hidden');}

        function jsddm_timer()
        {  closetimer = window.setTimeout(jsddm_close, timeout);}
        
        function jsddm_canceltimer()
        {  if(closetimer)
        {  window.clearTimeout(closetimer);
        closetimer = null;}}

        $(document).ready(function()
        {  $('#jsddm > li').bind('mouseover', jsddm_open)
        $('#jsddm > li').bind('mouseout',  jsddm_timer)});
        
        document.onclick = jsddm_close;
      </script>

      <ul id="jsddm">
        <li><a href="#">Files</a>
          <ul>
            <li><div id="slider">BED File<input type="file" id="input" onchange="handle(this.files)"></div></li>
            <li><a href="#">Annotations</a></li>
          </ul>
        </li>
        <li><a href="#">Bars</a>
          <ul>
            <li><div id="slider">Barsize<input type="range" name="barsize_s" min="10"
            max="100" value="30" onChange="update(barsize, this.value)" /> </div></li>

            <li><div id="slider">Radius/Width<input type="range" name="width_s" min="200"
            max="400" onChange="update(r, this.value)" /></div></li>

            <li><div id="slider">Shift out<input type="range" name="shiftout_s" min="0"
            max="100" onChange="update(shift_out, this.value)" /><div></li>
          </ul>
        </li>
      </ul>
      </div>
      <div id="center"><script type="text/javascript+protovis">
// setup panels and sizes
// root, "fullscreen"
var vis = new pv.Panel()
    .width(1440)
    .height(990);

var p1 = vis.add(pv.Panel)
    .width(width + margin)
    .height(width + margin);

var p2 = vis.add(pv.Panel)
    .width(width + margin)
//2 bars per line - shift and as much margin as we have lines
    .height((2*lines*barsize)-shift_in + margin*lines)
    .top(r*2 + margin);

// data massage
var data = mt2, max = pv.max(data, function(d) d.end );

var smalls = new Array();
//strip down trn sequence names and mark the small
for(var i in data) {
    if(data[i].name.indexOf("trn") == 0) {
	smalls.push(data[i]);
	data[i].name = data[i].name.substr(3, data[i].name.substr.length);
        data[i].isSmall = true;
    }
}

// //all data points that require ticks
var ticks = new Array();
for(var i in data) { ticks.push(data[i].start, data[i].end); }
ticks = ticks.unique();
// XXX what?
ticks.pop();

// wedge graphics
var ws = pv.Scale.linear(0, max).range(0, 2 * Math.PI);

var wedge = p1.add(pv.Wedge)
    .data(data)
    .top(r)
    .left(r)
    .strokeStyle("white")
    .lineWidth(1)
    .outerRadius(function(d) {
    	if(d.strand == "-") { return (r - barsize + shift_in); }
    	else { return r; }
    })
    .innerRadius(function(d) {
	if(d.strand == "-") { return (r - barsize*2 + shift_in); }
    	else { return r - barsize; }
    })
    .startAngle(function(d) ws(d.start))
    .angle(function(d) ws(d.end - d.start))
    .anchor("center").add(pv.Label)
    .text(function(d) { if(!d.isSmall) return d.name; else return ""; })
    .textAngle(function(d) Math.PI/2 + ws(d.start + Math.abs((d.start - d.end) / 2)) );

// bars //
// annotate the data with the line they belong to
function data_line(data, max_size) {
    var line = 0;
    for(var j in data) {
        if(data[j].end > max_size) {
            ++line;
            data[j].line = line;
            max_size += max_size;
        } else {
            data[j].line = line;
        }
    }
}

console.log(data);

// array of scales from minimal start to maximal end in each line scale from
data_line(data, max/lines);
var bottom = 0;
var line_val1 = 0;
var line_val2 = max/lines;
var bar_scales = new Array();
for(var i = 0; i < lines; ++i) {
    console.log(line_val1);
    console.log(line_val2);
    bar_scales.push(pv.Scale.linear(line_val1, line_val2).range(0, width));
    line_val1 += line_val2;
    line_val2 += line_val2;             
}

p2.add(pv.Bar)
    .data(data)
    .left(function(d) bar_scales[d.line](d.start))
    .width(function(d) bar_scales[d.line](d.end - d.start))
    .bottom(function(d) { return (barsize+margin) * d.line; })
        // if(d.strand == "-") return bottom;
    	//                   else return bottom + (barsize - shift_in); })
    .height(30)
    .lineWidth(1)
    // .fillStyle(function(d) { if(d.strand == "-") return "blue";
    // 	                     else return "red"; })
    .strokeStyle("white")
    .anchor("center").add(pv.Label)
    .text(function(d) { if(!d.isSmall) return d.name; else return ""; });

vis.render();

    </script>
  </div>
</body>
</html>
